# 双目视觉

## 1. 目的

通过两个摄像头的已知角度和距离，对两个摄像头所拍摄的两张照片进行处理，恢复原始三维图像。

基于项目背景，初步目的是：输入在两个已给定的视角下的视频，输出关键点的三维坐标随时间变化的json文件。（我觉得json的格式可能并不是那么好）

这里需要讨论，

## 2. 基础算法

[OpenCV官方文档中对特征识别的算法的介绍](https://docs.opencv.org/3.0-beta/doc/py_tutorials/py_feature2d/py_table_of_contents_feature2d/py_table_of_contents_feature2d.html)

### 特征点检测/描述算法

Harris角点检测，有旋转平移不变性，并不是尺度不变。

Shi-Tomasi角点检测算子

FAST(Feature from Accelerated Segment Test)算子

### 特征点匹配算法

SIFT

特征点匹配不需要全局的知识，只需要一个小邻域内的知识就行了。

最终，想要的是在两张照片中哪些特征点可以判定是一样的。这里说一些失败案例，因为没有双摄像头，就在网上随便找了一下在两个不同角度拍摄的人像图片，发现经常失配。可能是我的参数调的不好，也可能是两张照片中的环境噪声，曝光率什么的有很大差别。等到双摄像头到了之后再重新做实验。

总之，我觉得图像范围越小越好。

## 3. 拟实现流程

### 3.0 输入

将问题化简为：给定两张同一时间的照片，重建出该时间的14个骨骼节点的三维坐标

所以输入是：

- 两张照片
- 各照片的14个节点坐标（二维），以及节点是否可见的标记

### 3.1 假设

假设现在的骨骼节点识别已经足够快速以及足够准确（可能有些误差，我们能知道预测误差的均值是多少，设为: $\delta_{error}$）。

假设两个摄像头等距分居人行走的路径两侧，即：摄像头拍到的人大小差不多相等（没这个假设的话，图片画圆的半径还要等比例变化，就比较麻烦）

### 3.2 预处理

对于第m张图片：

- 转成灰度图像，normalization，使得其方差均值是要求的那样（锐化或者[histogram equalization](https://docs.opencv.org/2.4/doc/tutorials/imgproc/histograms/histogram_equalization/histogram_equalization.html)）。原因是尽可能减少不同角度拍摄到的照片上面的不确定因素。保留原有的SIFT特征（玄学，需要好好研究一下原论文和讨论区）。该处，方差和均值是超参数。

- 对于第n个骨骼节点：
  - 以关注区域半径$r>\delta_{error}$，圆心为该骨骼节点取一个圆（这个关注区域半径究竟定义成多大才能正确找到足够多的特征点这还另说，可能是跟骨骼节点的属性有关。）半径是超参数，可能：不同骨骼节点对应不同关注区域半径。（这个认识还是AIChallenger的baseline给我的，但是没有在抓特征值这个领域尝试过）
  - 调用SIFT生成该区域的特征点及特征向量（选择原论文中最好的(4,4,8)共128维向量的表示方法）

最终传给下一步的是一个字典：

```
pictureID: from 1 to 2:
	keypoint: from 1 to 14:
		feature_keypoint: from 1 to *:
			shape(feature_keypoint[i]) = (4,4,8,2)
	
```

### 3.3 特征点匹配

对于第1张图片的第n个骨骼节点中的第i个特征点：

- 对于第2张图片的第n个骨骼节点中的第j个特征点：
  - 计算两个特征点之间的欧式距离，若小于某个阈值（阈值是超参数），则判定这两个点是同一个三维空间中的点。

### 3.4 三维重建

问题化简成了：给定一个骨骼节点周围的一堆点在不同摄像头下的坐标，求这个骨骼节点在空间中的对应坐标。

首先确认三维空间的参考点，其次通过一个骨骼节点周围的一堆点在不同摄像头下的坐标找到从二维映射到三维的函数，最终代入两个不同参考点的坐标，取三维映射后的中点作为三维坐标系下的骨骼节点坐标。

## 4. 对于目的的思考

能否通过骨骼节点猜测出疾病？无对应的数据，只能做无监督或者半监督。

### 4.1 估计距离

在空间中有两个点，现在选择两个摄像头拍摄这两个点，如何知道这两个点所构成的三维向量在以米为度量下的真实度量？

这个问题倒是可以回答，但是该回答是基于：

- 摄像头之间的距离已知
- 摄像头与地面的高度相同
- 摄像头之间视角的成角已知
- 摄像头的视角均与地面平行

等约束（暂时只想到这些）下的回答。

因为人工维护摄像头的相对位置是有误差的，我希望能够使用尽可能少的约束达到精确的估计。这些数学还没有开始做。。。

### 4.2 隐藏节点

隐藏节点在一张图片中可能存在，但是在另一张图片中就可能不存在了。所以尽量使得每张图片都没有隐藏节点（这对病人走路的姿势和摄像头的布置要求比较高。）

### 4.3 简化流程

在3.4中提到的“通过一个骨骼节点周围的一堆点在不同摄像头下的坐标找到从二维映射到三维的函数”，这个函数是否可以通过：只找一个骨骼节点就可以估计出这个函数呢？

这个需要后期实验得出关系。

## 5. 布点的困难所在

若是采用双摄像头这个技巧的话，需要固定摄像头的相对位置和摄像头视线的成角。在不同的地方维护这一特征很难：人工维护一定存在误差，而引入一些设备的话有比较昂贵，所以这里还需要进一步的思考。

1. 可采用将两个摄像头粘在一起的方式，摄像头之间用一个三角形的楔子提供夹脚，在出厂的时候需要调试，到了布点的用户那里就差不多可以直接用了。可提供水平仪和固定长度的铅坠，保证水平位置和离地距离都受约束。

# 画钟

## 使用GAN做画钟图像生成的局限

1. 每个不同侧面的例子数目比较多
2. 如果例子比较少的话，生成出来的图像将没有差异。GAN提供了一个generator，该generator可以视作是一个将某种分布（正态分布之类的）映射到生成图像的高维分布中去的一个函数。如果某种打分下的例子太少的话（举个例子，评分为1011001的钟表只有19张），以随机从某种分布（正态分布之类的）中提取出的key输入进网络，输出的图片很少有不同点。该问题在stackexchange上曾被提出来过，叫 mode collapse。

> but I can imagine that in this case the generator will learn to ignore the input noise and always produce the same output which is a copy (a very close to) one of the real examples. I though that by classifying a batch we can also take into account the diversity (distribution) of the generated entities. For example, if we try to generate numbers coming from a Gaussian distribution, it would be impossible to decide whether a single number is "real" or "generated". In case of a set of number we can, in theory, determine whether it is coming from a real distribution of generated.

3. 如果拿全部样本做训练的话，我担心一点，就是生成出来的“可以进行评分的正例”

- 钟表轮廓不连续
- 钟表上的数字模糊
- 指针无法做到很直

从而使得“可以进行评分的正例”很局限，特少能有评分高的。如果未来使用这些数据进行训练评分网络的话，数据分布是个大问题。我对于GAN的理解仅限于原始论文和之前的图像经验，感觉图片质量和找可以使用例子的工作量会比较大。

# 其他

## 1. 除以上工作之外的时间花销

1. 看了几本书充了一下电
   - Multi-View Stereo: A Tutorial（未看完）
   - 重新看了一下西瓜书的一些部分
   - Computer Vision: Algorithms and Applications
2. 背英语单词顺便刷题
3. 整理了一部分微信的收藏夹相关文章
4. 成功不通过通宵的方式吃了一周的早餐。。。

## 2. 问题

1. 高斯卷积核

   Lindeberg等人已证明高斯卷积核是实现尺度变换的唯一变换核，并且是唯一的线性核。[Scale-space theory: A basic tool for analysing
   structures at different scales](https://cds.cern.ch/record/400314/files/p27.pdf)为啥高斯有这么好的特征？这篇文章可能是一个不错的切入点。

2. normalization

# 接下来的任务

1. 把微信公众号和微博收藏的文章整理一下。。。欠了一个月的债了
2. 文本摘要方向的调研
3. 接着上周没做完的地方继续做

- 画钟
- SPPE的评估

我觉得我下周只能做一个。。。两个都做吃不消。。。

4. 拿着新摄像头先拍两张照片看看能不能生成出一个三维骨架先
5. 求复杂度的水平不行，想重新看一下算法基础
6. 整理录音笔里面的所有录音文本（要是有一个从SD卡里面读取录音然后再转化成文字的应用程序就好了）


顺便做一个笔记：新买的摄像头配上附送的三脚架，几个参数如下：
- 离地距离：67cm，这是该三脚架能到达的最高位置。
- 与墙距离：414cm（水平最大距离）。
- 墙上能够拍到的最坏情况的最高位置：157cm。最坏位置为人与摄像机距离为墙的距离的时候。
- 人是沿着墙走的。

综上，我们需要一个简易的、可移动的水平仪检测摄像头的水平情况。
可能还需要一个比较稳定的，可以将摄像头抬高的三脚架。
