# 1. 画钟评分

## 1.1 已实现的细节

### 1.1.1 识别过程的可视化

虽然在最终的应用场景中，医生向整个系统中输入单张病人画钟图片，但是在调整算法的过程中需要对更多的步骤采取可视化分析。所以，在调试过程中如果能看到以下细节的话，会更方便调整一些超参数（例如二值化阈值等）：

1. 原始图像二值化处理后的结果；
2. 所有在二值化图像中识别出的轮廓；
3. 各个抓取到的数字在输入进网络之前的样子；
4. 采用摄像头动态捕捉的输入方式，省去了画钟-拍摄-存进电脑-运行程序读取画钟图片这一过程。

### 1.1.2 调整在画钟图片上抓取到的数字的“风格”

目前比较适合该应用的数据集就是MNIST，但是由于MNIST生成的方法未知，所以很难做到在画钟图片上抓到的数字与MNIST的风格一致。如果风格不一致的话，很有可能导致识别精度不足。所以在代码中修改了抓取二值化后的画钟图片中的数字的后处理过程，尽量还原其灰度细节。

### 1.1.3 评分模式

Baseline的设计理念是：因为缺少足够的端到端训练数据，所以不使用端到端模型（输入画钟图像，输出评分）。

> 说明：目前所得到的**真实**病人画的钟的图像仅有1145张，远远小于整个模型的待定参数量；并且这些样本是没有进行标注的。所以，如果采用端到端模型的话，该模型会出现严重的过拟合现象，并且标注样本和预处理样本的工作量将会很大。

为解决评分问题，使用基于规则的方法。

> 说明：基于规则的方法中"基于规则"主要指：获得各个数字的位置、指针指向的位置以及指针的属性（时针还是分针），并基于这些数据推测评分。

难点在于：

1. 出现缺失值（某个数字没有写/某个指针没有画出来/...）之后该评分系统的鲁棒性；
2. 本没有缺失值，但是某些组件（指针/数字）没有在上一步检测出来，导致评分错误。

目前的评分系统可以对我画出来的**没有出现格式上的错误**但是**有刻意的逻辑上的错误**的样本进行评分。

> 说明："格式上的错误"是指因为画法的不确定性影响到寻找**各个数字/指针的相关属性**，包括但不限于：数字与边界/指针有交点，框住指针的bounding box中存在任何属于数字的像素，两数字之间的距离过小以至于对于任意的能框住其中任意一个数字的bounding box中都会有另一个数字所属像素，等。
>
> “逻辑上的错误”是指因为画钟样本中可被检测/已考虑到的一些规则上给定的缺陷，包括但不限于：缺失数字/指针，指针指向位置的错误，等。

### 1.1.4 重构代码

考虑到以后对于抓取数字这一步骤的大改，将代码功能分离会便于调试。

### 1.1.5 识别错误的数字的可保存性

因为担心MNIST数据集不能描绘出病人写数字的pattern，所以当识别错误的时候，运行中的程序可通过键盘打断，并且保存识别错误的数字图像，方便以后进行训练。

## 1.2 Baseline采用的检测手段

Baseline采用的方法如下：

1. 先二值化然后再采用形态学腐蚀膨胀，根据摄像头的位置和光照强度选择恰当的阈值，使得：没有应该连续的笔画断掉，得到二值化图像；
2. 检测二值化图像中的所有contour，根据面积从大到小返回一个列表；
3. 认为最大面积和第二大面积的contour是钟表外轮廓，第三大的contour是指针，去掉这三项，将剩下的contour分别用框框住，返回每个框，并认为这些框内部的内容为数字；
4. 将所有数字框作用于原图，抓取到原图上的对应数字，灰度化之后再采用形态学腐蚀膨胀，将处理后的各个数字输入进识别网络，得到各个数字的中心位置以及数字分类；
5. 合并10，11，12，最终得到一个(12,4)的列表：使用（X坐标，Y坐标，数字类型，是否可见）表征所有数字；
6. 处理第3步中的指针contour，找到两指针交点和指向；
7. 评估。

## 1.3 Baseline的问题

### 1.3.1 画钟样本中暴露出的问题

从现在收集到的1145份画钟图像中看到的问题有：

1. 12与6的连接线是斜的，这样的话依然评估为有效钟表。
2. 指针重复描，划死指针。
3. 两个指针中间没有连接。
4. 将数字写在钟表外，这被医生理解为正确。也就是说，不能先去掉边框之后再进行识别数字的工作。换句话说，病人画的钟上面的数字在里面还是在外面是不能被控制的。
5. 在钟表外部轮廓上画刻度，如果刻度与外轮廓不结合的话可能会导致识别不准（一般而言都是与外轮廓结合的不紧密），这个现象很常见。
6. 数字与外轮廓结合，去掉外轮廓的时候可能会将数字去掉（轮廓与数字相互干扰）。
7. 若是数字写错了，病人会在原来错误的数字上重新写正确的数字或者划掉错误的数字重写，医生判对。
8. 数字写的不规范，比如11前面的1像是一个点之类的，但是医生判对；比如12两个数字写的重合了，医生判对。
9. 画指针的时候中间划一个圆圈形的指针连接器，不好进行对指针的识别。
10. 指针撞到了数字上或者撞到了轮廓上。
11. 用两条线表示指针（像是一个三角形）
12. 下笔太轻，导致笔画断断续续。
13. 最大的问题是有的人钟画得太小了，拍照的话很难给出一个很不错的识别结果。钟小的话，腐蚀元素大小就不能控制变量，所以可能还要做一个超分辨率的模块。
14. 数字方向不对，有些数字是上下颠倒的。
15. 对于画钟图像的预处理不足。

其中，我觉得：

1. 样本仅仅是一个评估手段，而不是学习内容，所以可以忽略掉一些画得不好的样本。关于什么样本可以被忽略的问题需要讨论：什么样的样本是医生觉得确实是收集时有问题的，而不能仅仅通过我们的想法武断地去除一些样本；
2. 去除一些样本后，对于剩下的样本，应做个预处理：仅截取钟表部分。若病人画的钟太小，导致截出来的钟的像素值小于(400,400)，该样本可以被忽略或者用超分辨率的方法处理（我觉得`resize()`方法并不好）。

> 像素值的阈值是基于MNIST样本集得出的。鉴于MNIST中每一个数字的分辨率是(28,28)，我希望从样本中截取出来数字的分辨率是大于此的：在应用场景下我们可以保证拍出来的画钟样本一定远大于(400,400)，所以我不希望因为评估样本的低分辨率影响到我对于算法有效性的判断，换言之，算是一种控制变量的思路。

### 1.3.2 识别准确率

可能是因为MNIST的数据集偏向于欧美人写数字的pattern，很多时候会出现对数字的识别错误。

## 1.4 可能的解决方法

问题集中在：

1. 抓取数字和指针：基于像素的连接与否来抓取数字，该方法的鲁棒性真的很差；
2. 判定数字的标签；
3. 具有鲁棒性的评分标准。

### 1.4.1 使用预训练的可行域生成网络进行对数字的抓取

此方法所解决的问题是：如何解决在1.3.1中提到的问题样本上有效抓取数字的问题。

一般的，如果一个做图像抓取的网络没有经过正确的训练，其生成可行域的组件是没有意义的。所以，找一个合适的能生成bounding box的网络和合适的训练集是一件必须的事情。

但是，在现在可以解决该类问题的网络中，诸如YOLO、RCNN等，存在着一个问题：其损失函数需要原始样本中含有bounding box信息，这是MNIST数据集所不能提供的。所以我就在想，能否仅仅使用经过裁剪的、带有标签的图像取代原始的、带有bounding box信息的图像训练诸如YOLO之类的网络？

### 1.4.2 增大训练集

此方法所解决的问题是：假设我们已经能够抓取到足够精确的数字了，解决更准确地预测数字的标签这一问题。

比较耗时间，要将所有能够作为inference的样本检测一遍，挑出检测错误的，并且将其重新标注，重新做一个扩大版本的MNIST。

### 1.4.3 改SGD

此方法所解决的问题是：假设我们已经能够抓取到足够精确的数字了，解决更准确地预测数字的标签这一问题。

在[Scalable Natural Gradient Langevin Dynamics in Practice](https://arxiv.org/pdf/1806.02855.pdf)这篇论文中提到了Stochastic Gradient Langevin Dynamics，该论文的作者在SciPy这个workshp里面有做presentation。

简而言之，改论文采用了热力学的Langevin Dynamics概念改动SGD，让SGD的随机误差更多地被一个从方差为lambda的正态分布中取样。将该网络作用于一个改进后的11分类的MNIST数据集中，得到：

1. 权重的分布范围扩大了；
2. 将Non MNIST的数据集输入作为inference，改进后的模型能够更好地区分这些不是数字。

这样的方法（将统计力学和热力学中的一些概念和公式借鉴到改进网络的方法中）或许能带给整个网络一些想不到的改变：网络最终收敛到全局最优并不等同于其泛化性能强，甚至恰恰相反。

### 1.4.4 Attention

似乎在上交的那个workshop里面听过无监督直接在一张图中找到人们所关注的一些特征位置的方法，是用来在视频里找outlier的，这个方法可以一试。回头找一下。

# 2. 骨骼节点捕捉

## 2.1 目前使用的方法

应用场景很重要。

### 2.1.1 AlphaPose

### 2.1.2 局限性

1. 视频信息的浪费
2. NMS策略的设计上出现了很大的问题
3. 架构很美但是没有理论上的理由说明该架构的合理性，仅通过实验证明的。

骨骼节点的识别其实就是捕捉关节周围的像素，从中发现信息。但是我觉得骨骼节点这东西在定义的时候就有一定的运动成分，使用运动的视频来帮助检测骨骼节点是一个理所当然出现的思路。

## 2.2 通过骨骼节点判断更多信息

可帮助三维建模，可帮助判断运动种类，等等。

立足点不稳：骨骼节点的检测本就有一些未解决的问题，做top-down方法本就有一些unimportant的味道在里面。

CVPR上，越来越少的论文是关于精妙的架构、网络的各种层之间的各种通信、预训练与未训练的模型混合训练等等方面。

# 3. 新的想法

## 3.1 使用强化学习做监督学习任务

现在的图像识别、图像分割等等都是基于监督学习，对标注样本的需求是很大的；但是，标注样本存在着几个缺陷：

1. 标注样本的质量参差不齐：标注样本基本上是出自一些血汗工厂，对于标注样本这个过程的品控我估计是不行的，所以在AIChallenger等数据集中，会发现很多识别框没有紧紧地框住事实；
2. 标注样本永远不能与真实场景相吻合：以骨骼节点识别为例，我们使用很多诸如足球场、商店、发布会等等场景中的人的骨骼节点标注作为训练识别**在医院里的病人的骨骼节点**的训练集，这中间会有很多的domain gap。虽然我现在还没有发现讲这个domain gap究竟对最终结果的理论性分析的paper，但是潜意识中觉得可能不行。

强化学习属于无监督学习，比较适合在一个**受限制的环境**中进行自主训练。所以在自动控制领域（Boston Dynamics）和游戏领域（DeepMind，OpenAI）这两个规则给定的领域中，强化学习用得蛮多的。

> 说明：受限制的环境是指：这个环境有很友好、很直观的反馈，以至于当一个智能体做出某一个决定的时候，环境会直接告诉它这个决定是好还是坏。

但如果在图像领域中使用在控制领域比较成功的强化学习的话，有一个很大的问题：图像识别这件事情是不能直接给出反馈的。所以我计划做图像的语义分割。Ground truth可以使用深度摄像头或者ETH出的一个似乎叫Motion Camera的东西（论文我回头找一下，打印的材料在实验室）。

>用深度摄像头的话，在室外会被各种频率的光线干扰，导致深度信息出不来；这个先假设叫motion camera的设备有很好的实时性，有很好的鲁棒性，其检测的是轮廓的变化，比较像光流产生出的图像。

分割任务交给强化学习，搭载在移动设备上（别衣服上或者直接绑无人机上之类的），剩下的我还没想好。

## 3.2 Thermodynamics & DL

热力学和统计力学毫无疑问启发了很多模型的设计，在SciPy Workshop那个视频（连接忘记了）里面有一张表，阐释了很多TD和DL的相似方面。

但我觉得真正有意思的地方在于：一杯水是如何冷却的？光线是如何确定从一种介质中传播到另一种介质的路线的？这种粒子的决策是否能够替代反向传播？

对TD的讨论主要还是集中于：这杯水的冷却过程能否给我们一些改进反向传播的思路。我存个疑。